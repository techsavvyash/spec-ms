swagger: "2.0"
info:
  version: "1.0.0"
  title: 'CQUBE'

basePath: "/v0"

tags:
  - name: "spec"
  - name: "ingestion"

schemes:
  - "https"
  - "http"

paths:
  /spec/event:
    post:
      tags:
        - "spec"
      summary: "Create a new event Specification"
      description: "Add new event Specification"
      operationId: "eventSpecification"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            example:
              {
    "ingestion_type": "event",
    "event_name": "students_attendance",
    "input": {
        "type": "object",
        "properties": {
            "event_name": {
                "type": "string"
            },
            "event": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "date": {
                            "type": "string",
                            "shouldnotnull": true,
                            "format": "date"
                        },
                        "school_id": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 1000000000,
                            "maximum": 9999999999
                        },
                        "grade": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 1,
                            "maximum": 12
                        },
                        "gender": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "total_students": {
                            "type": "number",
                            "shouldnotnull": true
                        },
                        "students_attendance_marked": {
                            "type": "number",
                            "shouldnotnull": true
                        },
                        "students_marked_present": {
                            "type": "number",
                            "shouldnotnull": true
                        }
                    },
                    "required": [
                        "date",
                        "school_id",
                        "grade",
                        "gender",
                        "total_students",
                        "students_attendance_marked",
                        "students_marked_present"
                    ]
                }
            }
        },
        "required": [
            "event_name",
            "event"
        ]
    }
}
      responses:
        200:
          description: "Event Spec Created Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Event Spec Created Successfully"
              pid:
                type: "integer"
                example: 1
              event_name:
                type: "string"
                example: "students_attendance"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /spec/dimension:
    post:
      tags:
        - "spec"
      summary: "Create a new dimension Specification"
      description: "Add new dimension Specification"
      operationId: "dimensionSpecification"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            example: {
            "ingestion_type": "dimension",
    "dimension_name": "school_details",
    "input": {
        "type": "object",
        "properties": {
            "dimension_name": {
                "type": "string"
            },
            "dimension": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "grade": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 1,
                            "maximum": 12
                        },
                        "school_id": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 1000000000,
                            "maximum": 9999999999
                        },
                        "school_name": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "school_type": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "school_category": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "cluster_id": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 100000000,
                            "maximum": 999999999
                        },
                        "cluster_name": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "block_id": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 10000,
                            "maximum": 99999
                        },
                        "block_name": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "district_id": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 100,
                            "maximum": 999
                        },
                        "district_name": {
                            "type": "string",
                            "shouldnotnull": true
                        },
                        "state_id": {
                            "type": "number",
                            "shouldnotnull": true,
                            "minimum": 1,
                            "maximum": 99
                        },
                        "state_name": {
                            "type": "string",
                            "shouldnotnull": true
                        }
                    },
                    "required": [
                        "grade",
                        "school_id",
                        "school_name",
                        "school_type",
                        "school_category",
                        "cluster_id",
                        "cluster_name",
                        "block_id",
                        "block_name",
                        "district_id",
                        "district_name",
                        "state_id",
                        "state_name"
                    ]
                }
            },
            "target_table": {
                "type": "object",
                "shouldnotnull": true,
                "properties": {
                    "ingestion.school_details": {
                        "type": "string"
                    }
                }
            }
        },
        "required": [
            "dimension_name",
            "dimension"
        ]
    }
}

      responses:
        200:
          description: "Dimension Spec Created Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Dimension Spec Created Successfully"
              pid:
                type: "integer"
                example: 4
              dimension_name:
                type: "string"
                example: "school_details"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /spec/dataset:
    post:
      tags:
        - "spec"
      summary: "Create a new dataset Specification"
      description: "Add new dataset Specification"
      operationId: "datasetSpecification"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
           example: {
            "ingestion_type": "dataset",
    "dataset_name": "students_attendance_compliance_by_school",
    "input": {
        "type": "object",
        "properties": {
            "dataset_name": {
                "type": "string"
            },
            "dimensions": {
                "type": "object",
                "properties": {
                    "table": "ingestion.dimension_school",
                    "column": [
                        "school_id"
                    ],
                    "merge_on_col": "school_id"
                }
            },
            "dataset": {
                "type": "object",
                "properties": {
                    "items": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "date": {
                                    "type": "string",
                                    "shouldnotnull": true,
                                    "format": "date"
                                },
                                "school_id": {
                                    "type": "integer",
                                    "shouldnotnull": true,
                                    "minimum": 1000000000,
                                    "maximum": 9999999999
                                },
                                "sum_students_attendance_marked": {
                                    "type": "integer",
                                    "shouldnotnull": true
                                },
                                "sum_total_students": {
                                    "type": "integer",
                                    "shouldnotnull": true
                                },
                                "percentage": {
                                    "type": "number",
                                    "shouldnotnull": true
                                }
                            },
                            "required": [
                                "date",
                                "school_id",
                                "sum_students_attendance_marked",
                                "sum_total_students",
                                "percentage"
                            ]
                        }
                    },
                    "group_by": [
                        "date",
                        "school_id"
                    ],
                    "aggregate": {
                        "type": "object",
                        "properties": {
                            "function": [
                                "sum"
                            ],
                            "target_table": "ingestion.SAC_students_attendance_compliance_by_school",
                            "numerator_col": "students_attendance_marked",
                            "denominator_col": "total_students",
                            "update_cols": [
                                "sum_students_attendance_marked",
                                "sum_total_students",
                                "percentage"
                            ],
                            "columns": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "column": [
                                            "students_attendance_marked",
                                            "total_students"
                                        ]
                                    }
                                }
                            },
                            "required": [
                                "function",
                                "target_table",
                                "update_cols",
                                "columns"
                            ]
                        }
                    },
                    "required": [
                        "items"
                    ]
                }
            },
            "required": [
                "dataset_name",
                "dataset"
            ]
        }
    }
}
      responses:
        200:
          description: "Dataset Spec Created Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Dataset Spec Created Successfully"
              pid:
                type: "integer"
                example: 3
              dataset_name:
                type: "string"
                example: "students_attendance_compliance_by_school"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /spec/transformer:
    post:
      tags:
        - "spec"
      summary: "Create a new transformer Specification"
      description: "Add new transformer Specification"
      operationId: "transformerSpecification"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              ingestion_name:
                type: "string"
                example: "students_attendance"
              key_file:
                type: "string"
                example: "transformer_dataset_mapping.csv"
              program:
                type: "string"
                example: "SAC"
              operation:
                type: "string"
                example: "dimension/dataset"
      responses:
        200:
          description: "Transformer Spec Created Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Transformer created successfully"
              response:
                type: "array"
                items:
                  type: "object"
                  properties: 
                    pid: 
                      type: "number"
                      example: 1
                    
                    file: 
                      type: "string"
                      example: SAC_students_attendance_compliance_by_school.py
                    
                  
              
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /spec/pipeline:
    post:
      tags:
        - "spec"
      summary: "Create a new pipeline Specification"
      description: "Add new pipeline Specification"
      operationId: "pipelineSpecification"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              pipeline_name:
                type: "string"
                example: "students_attendance_compliance_by_school"
              pipeline_type:
                type: "string"
                example: "ingest_to_db/dimension_to_db/dataset_to_db"
              pipeline:
                type: "array"
                items:
                  type: "object"
                  properties:
                    event_name:
                      type: "string"
                      example: "students_attendance"
                    dataset_name:
                      type: "string"
                      example: "students_attendance_compliance_by_school"
                    dimension_name:
                      type: "string"
                      example: "school_details"
                    transformer_name:
                      type: "string"
                      example: "SAC_students_attendance_compliance_by_school.py"

      responses:
        200:
          description: "Pipeline "
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Processor group running successfully"
             
                

        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /spec/schedule:
    post:
      tags:
        - "spec"
      summary: "create a Schedule"
      description: "Create a schedule"
      operationId: "createSchedule"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              pipeline_name:
                type: "string"
                example: "student_count_pipe"
              schedule_type:
                type: "string"
                example: "dimension_to_db/ingest_to_aggregate/aggregate_to_dataset"
              scheduled_at:
                type: "string"
                example: "12/12/2022 14:00:00"

      responses:
        200:
          description: "Schedule created Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Schedule created Successfully"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"

  /ingestion/event:
    post:
      tags:
        - "ingestion"
      summary: "Add Event into a CSV"
      description: "Add event"
      operationId: "addEvent"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              event_name:
                type: "string"
                example: "students_attendance"
              event:
                type: "array"
                items:
                  type: "object"
                  properties:
                    date:
                      type: "string"
                      example: "2022-06-12"
                    school_id:
                      type: "number"
                      example: 1234567891
                    grade:
                      type: "number"
                      example: 1
                    gender:
                      type: "string"
                      example: "male"
                    total_students:
                      type: "number"
                      example: 10
                    students_attendance_marked:
                      type: "number"
                      example: 8
                    students_attendance_present:
                      type: "number"
                      example: 2
      responses:
        200:
          description: "Event Added Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Event Added Successfully"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /ingestion/dimension:
    post:
      tags:
        - "ingestion"
      summary: "Add dimension into CSV"
      description: "Add dimension"
      operationId: "addDimension"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              dimension_name:
                type: "string"
                example: "school_details"
              dimension:
                type: "array"
                items:
                  type: "object"
                  properties:
                    grade:
                      type: "number"
                      example: 1
                    school_id:
                      type: "number"
                      example: 2402121120
                    school_name:
                      type: "string"
                      example: "Tirthgam Pri. Sch"
                    school_type:
                      type: "string"
                      example: "rural"
                    school_category:
                      type: "string"
                      example: "primary"
                    cluster_id:
                      type: "number"
                      example: 240212111
                    cluster_name:
                      type: "string"
                      example: "Sapreda"
                    block_id:
                      type: "number"
                      example: 24021
                    block_name:
                      type: "string"
                      example: "Vav"
                    district_id:
                      type: "number"
                      example: 240
                    district_name:
                      type: "string"
                      example: "Banaskantha"
                    state_id:
                      type: "number"
                      example: 1
                    state_name:
                      type: "string"
                      example: "UP"
      responses:
        200:
          description: "Dimension Added Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Dimension Added Successfully"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /ingestion/dataset:
    post:
      tags:
        - "ingestion"
      summary: "Add dataset"
      description: "Add dataset"
      operationId: "addDataset"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              dataset_name:
                type: "string"
                example: "students_attendance_compliance_by_school"
              dataset:
                  type: "object"
                  properties:
                    items:
                      type: "array"
                      items:
                        type: "object"
                        properties:
                          date:
                            type: "string"
                            example: 2022-12-01
                          school_id:
                            type: "number"
                            example: 1
                          grade:
                            type: "number"
                            example: 1
                          sum_students_attendance_marked:
                            type: "number"
                            example: 5
                          sum_total_students:
                            type: "number"
                            example: 10
                          percentage:
                            type: "number"
                            example: 50
      responses:
        200:
          description: "Dataset Added Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Dataset Added Successfully"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /ingestion/pipeline:
    post:
      tags:
        - "ingestion"
      summary: "Trigger the pipeline"
      description: "Trigger the pipeline"
      operationId: "triggerPipeline"
      produces:
        - "application/json"
      parameters:
        - in: "body"
          name: "body"
          required: true
          schema:
            type: "object"
            properties:
              pipeline_name:
                type: "string"
                example: "students_attendance_compliance_by_school"
      responses:
        200:
          description: "Processor Group Running Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "Processor Group Running Successfully"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"
  /ingestion/csv:
    post:
      tags:
        - "ingestion"
      summary: "CSV Import"
      description: "CSV Import"
      operationId: "csvImport"
      consumes:
        - "multipart/form-data"
      produces:
        - "application/json"
      parameters:
        - in: "formData"
          name: "body"
          type: file
          required: true
        - in: "formData"
          name: "ingestion_type"
          type: string
          required: true
        - in: "formData"
          name: "ingestion_name"
          type: string
          required: true

      responses:
        200:
          description: "CSV Uploaded Successfully"
          schema:
            type: "object"
            properties:
              message:
                type: "string"
                example: "CSV Uploaded Successfully"
        400:
          description: "Something went wrong"
          schema:
            $ref: "#/definitions/generic_error"

definitions:
  generic_error:
      type: "object"
      properties:
        message:
          type: "string"
          example: "Invalid Input"